<!DOCTYPE html>
<html lang="en">
  <head>   
    <title>Shallots Dashboard</title> 
    <meta name="description" content="shallots">
    <meta name="author" content="roosje">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <link href="/static/bootstrap.css" rel="stylesheet">
    <link href="/static/scrolling-nav.css" rel="stylesheet">
    <!--<script src="http://d3js.org/d3.v2.js"></script>-->
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script type="text/javascript" src="d3/d3.geom.js"></script>
    <script type="text/javascript" src="d3/d3.layout.js"></script>

    <script src="/static/d3.layout.cloud.js"></script>
    <script src="http://datamaps.github.io/scripts/datamaps.world.min.js?v=1"></script>

    <style type="text/css">

      #pieChart {    
          position:absolute;
          top:10px;
          left:10px;
          width:300px;
          height: 300px; 
          z-index: 1;
      }
      #wordCloud {    
          position:absolute;
          top:10px;
          left:10px;
          width:300px;
          height: 300px;
      }
      #graph {
          position:absolute;
          top:-80px;
          left:280px;
          width: 800px;
          height: 500px;
      }

      #map {
          position:absolute;
          top:370px;
          width:100%;
          height: 600px;
      }

      svg {
        height: 500px;
      }

      .slice {
         font-size: 11pt;
         font-family: Verdana;
         fill: white; //svg specific - instead of color
         font-weight: bold;   
      } 

      .node {
        stroke: #fff;
        stroke-width: 1.5px;
      }

      .link {
        stroke: #BBB;
        stroke-opacity: .5;
      }

      rect {
      fill: none;
      pointer-events: all;
      }

    </style>

<script>
/*
################ FORMATS ##################
-------------------------------------------
*/

var formatAsPercentage = d3.format("%"),
    formatAsPercentage1Dec = d3.format(".1%"),
    formatAsInteger = d3.format(",")
    ;

/*
############# PIE CHART ###################
-------------------------------------------
*/

function dsPieChart(error, dataset){
          //dataexample = {category: "name", measure:"rate"}

    var    width = 300,
           height = 300,
           outerRadius = Math.min(width, height) / 2,
           innerRadius = outerRadius * .999,   
           // for animation
           innerRadiusFinal = outerRadius * .5,
           innerRadiusFinal3 = outerRadius* .45,
           color = d3.scale.category20()    //builtin range of colors
           dataset = dataset
           ;
        
    var vis = d3.select("#pieChart")
         .append("svg:svg")              //create the SVG element inside the <body>
         .data([dataset])                   //associate our data with the document
         .attr("width", width)           //set the width and height of our visualization (these will be attributes of the <svg> tag
         .attr("height", height)
         .append("svg:g")                //make a group to hold our pie chart
         .attr("transform", "translate(" + outerRadius + "," + outerRadius + ")")    //move the center of the pie chart from 0, 0 to radius, radius
          ;
                
   var arc = d3.svg.arc()              //this will create <path> elements for us using arc data
            .outerRadius(outerRadius).innerRadius(innerRadius);
   
   // for animation
   var arcFinal = d3.svg.arc().innerRadius(innerRadiusFinal).outerRadius(outerRadius);
   var arcFinal3 = d3.svg.arc().innerRadius(innerRadiusFinal3).outerRadius(outerRadius);

   var pie = d3.layout.pie()           //this will create arc data for us given a list of values
        .value(function(d) { return d.measure; });    //we must tell it out to access the value of each element in our data array

   var arcs = vis.selectAll("g.slice")     //this selects all <g> elements with class slice (there aren't any yet)
        .data(pie)          //associate the generated pie data (an array of arcs, each having startAngle, endAngle and value properties) 
        .enter()            //this will create <g> elements for every "extra" data element that should be associated with a selection. The result is creating a <g> for every object in the data array
        .append("svg:g")   //create a group to hold each slice (we will have a <path> and a <text> element associated with each slice)
        .attr("class", "slice")    //allow us to style things in the slices (like text)
        .on("mouseover", mouseover)
        .on("mouseout", mouseout)
        .on("click", up);
                    
        arcs.append("svg:path")
               .attr("fill", function(d, i) { return color(d.data.category); } ) //set the color for each slice to be chosen from the color function defined above
               .attr("d", arc)     //this creates the actual SVG path using the associated data (pie) with the arc drawing function
               .append("svg:title") //mouseover title showing the figures
               .text(function(d) { return d.data.category + ": " + formatAsPercentage(d.data.measure); });          

        d3.selectAll("g.slice").selectAll("path").transition()
                .duration(750)
                .delay(10)
                .attr("d", arcFinal )
                ;
    
      // Add a label to the larger arcs, translated to the arc centroid and rotated.
      // source: http://bl.ocks.org/1305337#index.html
      arcs.filter(function(d) { return d.endAngle - d.startAngle > .2; })
          .append("svg:text")
          .attr("dy", ".35em")
          .attr("text-anchor", "middle")
          .attr("transform", function(d) { return "translate(" + arcFinal.centroid(d) + ")rotate(" + angle(d) + ")"; })
          //.text(function(d) { return formatAsPercentage(d.value); })
          .text(function(d) { return d.data.category; })
          ;
       
       // Computes the label angle of an arc, converting from radians to degrees.
        function angle(d) {
            var a = (d.startAngle + d.endAngle) * 90 / Math.PI - 90;
            return a > 90 ? a - 180 : a;
        }
              
        // Pie chart title          
        vis.append("svg:text")
            .attr("dy", ".35em")
          .attr("text-anchor", "middle")
          .text("Found topics")
          .attr("class","title")
          ;         

    function mouseover() {
      d3.select(this).select("path").transition()
          .duration(750)
                    //.attr("stroke","red")
                    //.attr("stroke-width", 1.5)
                    .attr("d", arcFinal3)
                    ;
    }
    
    function mouseout() {
      d3.select(this).select("path").transition()
          .duration(750)
                    //.attr("stroke","blue")
                    //.attr("stroke-width", 1.5)
                    .attr("d", arcFinal)
                    ;
    }
    
    function up(d, i) {
                /* update bar chart when user selects piece of the pie chart */
                //updateBarChart(dataset[i].category);
                slideoutwordcloud(d.data.category, color(i));
                updateWordcloud(d.data.category, color(i));
             
    }
}



/*
############# MAP ###################
-------------------------------------------
*/

function dsMap(){

  var map = new Datamap({
        scope: 'world',
        element: document.getElementById('map'),
        projection: 'equirectangular',
        
        fills: {
          defaultFill: '#b2b2b2',
           0: '#008833',
          .1: '#339933',
          .2: '#66AA33',
          .3: '#99BB33',
          .4: '#CCCC33',
          .5: '#DDCC33',
          .6: '#FFBB33',
          .7: '#FF9933',
          .8: '#FF6633',
          .9: '#FF3333',
           1: '#FF0033'
        },
        
        projectionConfig: {
          rotation:[91,-30]
        },

        geographyConfig: {
          hideAntarctica: true,
          popupTemplate: function(geography, data) { //this function should just return a string
          return '<div class="hoverinfo"><strong>' + geography.properties.name + '</strong></div>';
          },
          popupOnHover: true,
          highlightOnHover: true,
          highlightFillColor: '#000000',
          highlightBorderColor: '#000000'

        },
      
        data: {
          {% for cntr, score in datamap %}
          {{ cntr }}: {fillKey: {{ score }} },
          {% endfor %}    
        }
      })
      
      map.graticule();
    }



/*
############# WORD CLOUD ##################
-------------------------------------------
*/

/*
function dsCloud(error, nodes, links){

  d3.json('data/worddata.json', function(error, data) {

  var fill = d3.scale.category20();

  d3.layout.cloud().size([400, 400])
      .words(data.map(function(d) {
        return {text: d.text, size: 10 + Math.random() * 90};
      }))
      .padding(5)
      .rotate(function() { return ~~(Math.random() * 2) * 90; })
      //.font("Impact")
      .text(function(d) { return d.text;})
      .fontSize(function(d) { return d.size; })
      .on("end", draw)
      .start();

  function draw(words) {
    d3.select("wordCloud").append("svg")
        .attr("width", 400)
        .attr("height", 400)
      .append("g")
        .attr("transform", "translate(150,150)")
      .selectAll("text")
        .data(words)
      .enter().append("text")
        .style("font-size", function(d) { return d.size + "px"; })
        .style("font-family", "Impact")
        .style("fill", function(d, i) { return fill(i); })
        .attr("text-anchor", "middle")
        .attr("transform", function(d) {
          return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
        })
        .text(function(d) { return d.text; });
})}


*/

/*
############# GRAPH ##################
-------------------------------------------
*/

function dsGraph(error, nodes, links) {
    var w = 800,
        h = 400,
        color = d3.scale.category20c();

    var force = d3.layout.force()
        .gravity(0.06)
        .charge(-150)
        .linkDistance(w/5)
        .size([w, h]);

    var svg = d3.select("#graph").append("svg:svg")
        .attr("width", w)
        .attr("height", h)
        .append("svg:g")
        .attr("transform", "translate(" + w / 8 + "," + h / 6 + ")");

    svg.append("svg:rect")
    .attr("width", w)
    .attr("height", h)
    .style("stroke", "#FFF")
    .style("fill", "#FFF");

    var link = svg.selectAll("line")
      .data(links)
      .enter().append("svg:line")
      .attr("class", "link")
      .style("stroke-width", function(d) { return Math.sqrt(d.value); });

    var node = svg.selectAll("circle")
      .data(nodes)
      .enter().append("svg:circle")
      .attr("class", "node")
      //.attr("r", 3)
      .attr("r", function(d) {return Math.sqrt(d.size) || 4.5; })
      .style("fill", function(d) { return color(d.group); })
      .call(force.drag);

  force
      .nodes(nodes)
      .links(links)
      .on("tick", tick)
      .start();

  function tick() {
    node.attr("cx", function(d) { return d.x = Math.max(5, Math.min(w - 5, d.x)); })
        .attr("cy", function(d) { return d.y = Math.max(5, Math.min(h - 5, d.y)); });

    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });
  };

}

/*

  var link = svg.selectAll(".link")
      .data(links)
      .enter().append("line")
      .attr("class", "link")
      .style("stroke-width", function(d) { return Math.sqrt(d.value); });

  var node = svg.selectAll(".node")
      .data(nodes)
      .enter().append("circle")
      .attr("class", "node")
      //.attr("r", 3)
      .attr("r", function(d) {return Math.sqrt(d.size)/1.5 || 4.5; })
      .style("fill", function(d) { return color(d.group); })
      .call(force.drag);

  node.append("title")
      .text(function(d) { return d.domain; });

  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });
    
    node.attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  });

  force.start();
}*/

     /* ** UPDATE WORDCLOUD ** */
     
    /* updates on request */
    function updateWordCloud(group, colorChosen) {

    }

    function slideoutwordcloud(group, colorChosen) {

    }

    </script>
  </head>
  <body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="#page-top">Shallots</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse navbar-ex1-collapse">
                <ul class="nav navbar-nav">
                    <li class="hidden">
                        <a class="page-scroll" href="#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#about">About</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Intro Section -->
    <section id="intro" class="intro-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div id="pieChart"></div>
                    <div id="graph"></div>
                    <!--<div id="wordCloud"></div>-->
                    <div id="map"></div>
                    
                </div>
            </div>
        </div>
    </section>

    <!-- About Section -->
    <section id="about" class="about-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <h1>About Shallots</h1>
                </div>
            </div>
        </div>
    </section>

     <!-- Contact Section -->
    <section id="contact" class="contact-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <h1>Contact</h1>
                </div>
            </div>
        </div>
    </section>

    <script type="text/javascript">
    queue()
      .defer(d3.json, '/static/data/piedata.json')
      .await(dsPieChart);
    dsMap();
    queue()
      .defer(d3.json, '/static/data/nodes.json')
      .defer(d3.json, '/static/data/links.json')
      .await(dsGraph);
    //dsCloud();
    </script>
    
     <!-- jQuery -->
    <script src="/static/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/static/js/bootstrap.min.js"></script>

    <!-- Scrolling Nav JavaScript -->
    <script src="/static/js/jquery.easing.min.js"></script>
    <script src="/static/js/scrolling-nav.js"></script>
  </body>
</html>